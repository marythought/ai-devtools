{% extends 'todos/base.html' %}
{% load static %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'todos/css/todo-list.css' %}">
{% endblock %}

{% block title %}TODO List{% endblock %}

{% block content %}
    <h1>My TODO List</h1>

    <div class="todo-header">
        <div class="todo-header-buttons">
            <a href="{% url 'create_todo' %}" class="btn">Add New TODO</a>
            <a href="{% url 'manage_categories' %}" class="btn btn-secondary">Manage Categories</a>
        </div>
        {% if view_mode != 'due_soon' %}
            <div class="todo-header-toggle">
                <label class="toggle-label">
                    <input type="checkbox" id="show-completed-toggle" {% if show_completed == 'true' %}checked{% endif %} class="toggle-checkbox">
                    <span class="toggle-text">Show Completed</span>
                </label>
            </div>
        {% endif %}
    </div>

    <!-- Category Tabs -->
    <div class="category-tabs-wrapper">
        <div class="category-tabs">
            <a href="?show_completed={{ show_completed }}" class="category-tab {% if not selected_category and view_mode == 'default' %}active{% endif %}">
                All TODOs
            </a>
            <a href="?view=due_soon" class="category-tab {% if view_mode == 'due_soon' %}active{% endif %}">
                Due Soon
            </a>
            {% for category in categories %}
                <a href="?category={{ category.id }}&show_completed={{ show_completed }}" class="category-tab {% if selected_category == category.id|stringformat:'s' %}active{% endif %}">
                    {{ category.name }}
                </a>
            {% endfor %}
        </div>
    </div>

    {% if todos %}
        <div id="todo-list" class="todo-list-container">
            {% for todo in todos %}
                <div class="todo-item {% if todo.is_completed %}completed{% else %}incomplete{% endif %}" data-id="{{ todo.id }}" data-completed="{{ todo.is_completed|yesno:'true,false' }}">
                    <div class="todo-content">
                        {% if not todo.is_completed %}
                            <span class="drag-handle">☰</span>
                        {% else %}
                            <span class="drag-handle-placeholder">☰</span>
                        {% endif %}
                        <div class="todo-details">
                            <h3 class="todo-title {% if todo.is_completed %}completed{% endif %}">
                                {{ todo.title }}
                            </h3>
                            {% if todo.description %}
                                <p class="todo-description">{{ todo.description }}</p>
                            {% endif %}
                            <small class="todo-metadata">
                                Created: {{ todo.created_at|date:"M d, Y H:i" }}
                                {% if todo.due_date %}
                                    <br>Due: {{ todo.due_date|date:"M d, Y" }}{% if todo.due_date.hour > 0 or todo.due_date.minute > 0 %} at {{ todo.due_date|date:"g A" }}{% endif %}
                                {% endif %}
                                {% if todo.completed_at %}
                                    <br>Completed: {{ todo.completed_at|date:"M d, Y H:i" %}
                                {% endif %}
                            </small>
                        </div>
                    </div>
                    <div class="todo-actions">
                        {% if not todo.is_completed %}
                            <div class="todo-action-buttons">
                                <form method="post" action="{% url 'toggle_todo' todo.id %}" style="display: inline;">
                                    {% csrf_token %}
                                    <button type="submit" class="btn todo-action-button success">
                                        Dunzo
                                    </button>
                                </form>
                                <form method="post" action="{% url 'complete_and_followup' todo.id %}" style="display: inline;">
                                    {% csrf_token %}
                                    <button type="submit" class="btn todo-action-button">
                                        ✅ & Followup
                                    </button>
                                </form>
                            </div>
                        {% else %}
                            <form method="post" action="{% url 'toggle_todo' todo.id %}" style="display: inline;">
                                {% csrf_token %}
                                <button type="submit" class="btn btn-success todo-action-button">
                                    Mark Incomplete
                                </button>
                            </form>
                        {% endif %}
                        <div class="todo-links">
                            <a href="{% url 'edit_todo' todo.id %}" class="todo-link">Edit</a>
                            <form method="post" action="{% url 'delete_todo' todo.id %}" style="display: inline; margin: 0;">
                                {% csrf_token %}
                                <button type="submit" class="todo-delete-button" onclick="return confirm('Are you sure you want to delete this TODO?');">Delete</button>
                            </form>
                        </div>
                    </div>
                </div>
            {% endfor %}
        </div>
    {% else %}
        <p class="empty-state">No todos yet. Create your first one!</p>
    {% endif %}

    <script>
        // Handle show completed toggle
        const showCompletedToggle = document.getElementById('show-completed-toggle');
        if (showCompletedToggle) {
            showCompletedToggle.addEventListener('change', function() {
                const urlParams = new URLSearchParams(window.location.search);
                if (this.checked) {
                    urlParams.set('show_completed', 'true');
                } else {
                    urlParams.set('show_completed', 'false');
                }
                window.location.search = urlParams.toString();
            });
        }

        // Drag and drop functionality
        const todoList = document.getElementById('todo-list');
        if (todoList) {
            let draggedElement = null;

            todoList.addEventListener('dragstart', (e) => {
                const todoItem = e.target.closest('.todo-item');
                if (todoItem && todoItem.getAttribute('data-completed') === 'false') {
                    draggedElement = todoItem;
                    todoItem.style.opacity = '0.5';
                }
            });

            todoList.addEventListener('dragend', (e) => {
                const todoItem = e.target.closest('.todo-item');
                if (todoItem) {
                    todoItem.style.opacity = '1';
                }
            });

            todoList.addEventListener('dragover', (e) => {
                e.preventDefault();
                if (!draggedElement) return;

                const afterElement = getDragAfterElement(todoList, e.clientY);

                // Don't allow dragging incomplete items after completed items
                if (afterElement && afterElement.getAttribute('data-completed') === 'true') {
                    return;
                }

                if (afterElement == null) {
                    // Check if the last element is completed
                    const lastElement = todoList.lastElementChild;
                    if (lastElement && lastElement.getAttribute('data-completed') === 'true') {
                        return;
                    }
                    todoList.appendChild(draggedElement);
                } else {
                    todoList.insertBefore(draggedElement, afterElement);
                }
            });

            todoList.addEventListener('drop', (e) => {
                e.preventDefault();
                saveOrder();
            });

            function getDragAfterElement(container, y) {
                const draggableElements = [...container.querySelectorAll('.todo-item:not([style*="opacity: 0.5"])')];

                return draggableElements.reduce((closest, child) => {
                    const box = child.getBoundingClientRect();
                    const offset = y - box.top - box.height / 2;

                    if (offset < 0 && offset > closest.offset) {
                        return { offset: offset, element: child };
                    } else {
                        return closest;
                    }
                }, { offset: Number.NEGATIVE_INFINITY }).element;
            }

            function saveOrder() {
                const items = document.querySelectorAll('.todo-item');
                const todoIds = Array.from(items).map(item => parseInt(item.getAttribute('data-id')));

                fetch('{% url "reorder_todos" %}', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': '{{ csrf_token }}'
                    },
                    body: JSON.stringify({ todo_ids: todoIds })
                })
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'error') {
                        alert('Error reordering todos: ' + (data.message || 'Unknown error'));
                        location.reload();
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    location.reload();
                });
            }

            // Make incomplete items draggable
            document.querySelectorAll('.todo-item').forEach(item => {
                if (item.getAttribute('data-completed') === 'false') {
                    item.setAttribute('draggable', 'true');
                }
            });
        }
    </script>
{% endblock %}
