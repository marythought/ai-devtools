{% extends 'todos/base.html' %}

{% block title %}TODO List{% endblock %}

{% block content %}
    <h1>My TODO List</h1>

    <div style="margin-bottom: 20px; display: flex; gap: 10px; align-items: center; justify-content: space-between;">
        <div style="display: flex; gap: 10px;">
            <a href="{% url 'create_todo' %}" class="btn">Add New TODO</a>
            <a href="{% url 'manage_categories' %}" class="btn" style="background-color: #6c757d;">Manage Categories</a>
        </div>
        {% if view_mode != 'due_soon' %}
            <div style="display: flex; align-items: center; gap: 10px;">
                <label style="display: flex; align-items: center; cursor: pointer; user-select: none;">
                    <input type="checkbox" id="show-completed-toggle" {% if show_completed == 'true' %}checked{% endif %} style="margin-right: 8px; cursor: pointer; width: 18px; height: 18px;">
                    <span style="font-size: 14px; font-weight: 500;">Show Completed</span>
                </label>
            </div>
        {% endif %}
    </div>

    <!-- Category Tabs -->
    <div style="margin-bottom: 20px; border-bottom: 2px solid #ddd;">
        <div style="display: flex; gap: 5px; flex-wrap: wrap;">
            <a href="?show_completed={{ show_completed }}"
               style="padding: 10px 20px; text-decoration: none; border: 1px solid #ddd; border-bottom: none; border-radius: 4px 4px 0 0; {% if not selected_category and view_mode == 'default' %}background-color: white; border-bottom: 2px solid white; margin-bottom: -2px; font-weight: bold; color: #007bff;{% else %}background-color: #f8f9fa; color: #666;{% endif %}">
                All TODOs
            </a>
            <a href="?view=due_soon"
               style="padding: 10px 20px; text-decoration: none; border: 1px solid #ddd; border-bottom: none; border-radius: 4px 4px 0 0; {% if view_mode == 'due_soon' %}background-color: white; border-bottom: 2px solid white; margin-bottom: -2px; font-weight: bold; color: #007bff;{% else %}background-color: #f8f9fa; color: #666;{% endif %}">
                Due Soon
            </a>
            {% for category in categories %}
                <a href="?category={{ category.id }}&show_completed={{ show_completed }}"
                   style="padding: 10px 20px; text-decoration: none; border: 1px solid #ddd; border-bottom: none; border-radius: 4px 4px 0 0; {% if selected_category == category.id|stringformat:'s' %}background-color: white; border-bottom: 2px solid white; margin-bottom: -2px; font-weight: bold; color: #007bff;{% else %}background-color: #f8f9fa; color: #666;{% endif %}">
                    {{ category.name }}
                </a>
            {% endfor %}
        </div>
    </div>

    {% if todos %}
        <div id="todo-list" style="display: flex; flex-direction: column; gap: 15px;">
            {% for todo in todos %}
                <div class="todo-item" data-id="{{ todo.id }}" data-completed="{{ todo.is_completed|yesno:'true,false' }}" style="border: 1px solid #ddd; padding: 15px; border-radius: 4px; display: flex; justify-content: space-between; align-items: flex-end; {% if todo.is_completed %}background-color: #f8f9fa;{% else %}cursor: move;{% endif %}">
                    <div style="display: flex; align-items: flex-start; gap: 10px; flex: 1;">
                        {% if not todo.is_completed %}
                            <span class="drag-handle" style="color: #999; font-size: 18px; cursor: move; margin-top: 3px;">☰</span>
                        {% else %}
                            <span style="color: transparent; font-size: 18px; margin-top: 3px;">☰</span>
                        {% endif %}
                        <div style="flex: 1;">
                            <h3 style="margin-bottom: 8px; {% if todo.is_completed %}text-decoration: line-through; color: #6c757d;{% endif %}">
                                {{ todo.title }}
                            </h3>
                            {% if todo.description %}
                                <p style="color: #666; margin-bottom: 8px;">{{ todo.description }}</p>
                            {% endif %}
                            <small style="color: #999;">
                                Created: {{ todo.created_at|date:"M d, Y H:i" }}
                                {% if todo.due_date %}
                                    <br>Due: {{ todo.due_date|date:"M d, Y" }}{% if todo.due_date.hour > 0 or todo.due_date.minute > 0 %} at {{ todo.due_date|date:"g A" }}{% endif %}
                                {% endif %}
                                {% if todo.completed_at %}
                                    <br>Completed: {{ todo.completed_at|date:"M d, Y H:i" %}
                                {% endif %}
                            </small>
                        </div>
                    </div>
                    <div style="display: flex; flex-direction: column; align-items: flex-end; gap: 10px;">
                        {% if not todo.is_completed %}
                            <div style="display: flex; gap: 8px;">
                                <form method="post" action="{% url 'toggle_todo' todo.id %}" style="display: inline;">
                                    {% csrf_token %}
                                    <button type="submit" class="btn" style="padding: 8px 16px; font-size: 12px; background-color: #28a745; border-color: #28a745;">
                                        Dunzo
                                    </button>
                                </form>
                                <form method="post" action="{% url 'complete_and_followup' todo.id %}" style="display: inline;">
                                    {% csrf_token %}
                                    <button type="submit" class="btn" style="padding: 8px 16px; font-size: 12px;">
                                        ✅ & Followup
                                    </button>
                                </form>
                            </div>
                        {% else %}
                            <form method="post" action="{% url 'toggle_todo' todo.id %}" style="display: inline;">
                                {% csrf_token %}
                                <button type="submit" class="btn btn-success" style="padding: 8px 16px; font-size: 12px;">
                                    Mark Incomplete
                                </button>
                            </form>
                        {% endif %}
                        <div style="display: flex; gap: 10px; font-size: 12px;">
                            <a href="{% url 'edit_todo' todo.id %}" style="color: #dc3545; text-decoration: none;">Edit</a>
                            <form method="post" action="{% url 'delete_todo' todo.id %}" style="display: inline; margin: 0;">
                                {% csrf_token %}
                                <button type="submit" style="background: none; border: none; color: #dc3545; text-decoration: none; font-size: 12px; cursor: pointer; padding: 0; font-family: inherit;" onclick="return confirm('Are you sure you want to delete this TODO?');">Delete</button>
                            </form>
                        </div>
                    </div>
                </div>
            {% endfor %}
        </div>
    {% else %}
        <p style="color: #666; text-align: center; padding: 40px 0;">No todos yet. Create your first one!</p>
    {% endif %}

    <script>
        // Handle show completed toggle
        const showCompletedToggle = document.getElementById('show-completed-toggle');
        if (showCompletedToggle) {
            showCompletedToggle.addEventListener('change', function() {
                const urlParams = new URLSearchParams(window.location.search);
                if (this.checked) {
                    urlParams.set('show_completed', 'true');
                } else {
                    urlParams.set('show_completed', 'false');
                }
                window.location.search = urlParams.toString();
            });
        }

        // Drag and drop functionality
        const todoList = document.getElementById('todo-list');
        if (todoList) {
            let draggedElement = null;

            todoList.addEventListener('dragstart', (e) => {
                const todoItem = e.target.closest('.todo-item');
                if (todoItem && todoItem.getAttribute('data-completed') === 'false') {
                    draggedElement = todoItem;
                    todoItem.style.opacity = '0.5';
                }
            });

            todoList.addEventListener('dragend', (e) => {
                const todoItem = e.target.closest('.todo-item');
                if (todoItem) {
                    todoItem.style.opacity = '1';
                }
            });

            todoList.addEventListener('dragover', (e) => {
                e.preventDefault();
                if (!draggedElement) return;

                const afterElement = getDragAfterElement(todoList, e.clientY);

                // Don't allow dragging incomplete items after completed items
                if (afterElement && afterElement.getAttribute('data-completed') === 'true') {
                    return;
                }

                if (afterElement == null) {
                    // Check if the last element is completed
                    const lastElement = todoList.lastElementChild;
                    if (lastElement && lastElement.getAttribute('data-completed') === 'true') {
                        return;
                    }
                    todoList.appendChild(draggedElement);
                } else {
                    todoList.insertBefore(draggedElement, afterElement);
                }
            });

            todoList.addEventListener('drop', (e) => {
                e.preventDefault();
                saveOrder();
            });

            function getDragAfterElement(container, y) {
                const draggableElements = [...container.querySelectorAll('.todo-item:not([style*="opacity: 0.5"])')];

                return draggableElements.reduce((closest, child) => {
                    const box = child.getBoundingClientRect();
                    const offset = y - box.top - box.height / 2;

                    if (offset < 0 && offset > closest.offset) {
                        return { offset: offset, element: child };
                    } else {
                        return closest;
                    }
                }, { offset: Number.NEGATIVE_INFINITY }).element;
            }

            function saveOrder() {
                const items = document.querySelectorAll('.todo-item');
                const todoIds = Array.from(items).map(item => parseInt(item.getAttribute('data-id')));

                fetch('{% url "reorder_todos" %}', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': '{{ csrf_token }}'
                    },
                    body: JSON.stringify({ todo_ids: todoIds })
                })
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'error') {
                        alert('Error reordering todos: ' + (data.message || 'Unknown error'));
                        location.reload();
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    location.reload();
                });
            }

            // Make incomplete items draggable
            document.querySelectorAll('.todo-item').forEach(item => {
                if (item.getAttribute('data-completed') === 'false') {
                    item.setAttribute('draggable', 'true');
                }
            });
        }
    </script>
{% endblock %}
