name: Deploy TODO App

# Trigger deployment only when the CI workflow completes successfully.
on:
  workflow_dispatch:
  workflow_run:
    workflows:
      - "CI for TODO App"
    types:
      - completed

defaults:
  run:
    working-directory: 01-todo

jobs:
  deploy:
    # Only run this job when the CI workflow completed successfully on the main branch
    if: ${{ (github.event_name == 'workflow_dispatch') || (github.event.workflow_run.conclusion == 'success' && github.event.workflow_run.head_branch == 'main') }}

    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v4

    - name: Setup SSH
      env:
        SSH_PRIVATE_KEY: ${{ secrets.PYTHONANYWHERE_SSH_KEY }}
      run: |
        mkdir -p ~/.ssh
        echo "$SSH_PRIVATE_KEY" > ~/.ssh/pythonanywhere_key
        chmod 600 ~/.ssh/pythonanywhere_key
        ssh-keyscan ssh.pythonanywhere.com >> ~/.ssh/known_hosts

    - name: Deploy to PythonAnywhere via SSH
      env:
        PYTHONANYWHERE_USERNAME: ${{ secrets.PYTHONANYWHERE_USERNAME }}
        PYTHONANYWHERE_DOMAIN: ${{ secrets.PYTHONANYWHERE_DOMAIN }}
        PYTHONANYWHERE_API_TOKEN: ${{ secrets.PYTHONANYWHERE_API_TOKEN }}
      run: |
        echo "Starting deployment to PythonAnywhere..."

        ssh -i ~/.ssh/pythonanywhere_key \
          -o StrictHostKeyChecking=no \
          ${PYTHONANYWHERE_USERNAME}@ssh.pythonanywhere.com \
          "bash -s ${PYTHONANYWHERE_DOMAIN}" << 'ENDSSH'
          set -e
          DOMAIN=$1

          echo "Pulling latest code..."
          cd ~/ai-devtools/01-todo
          git pull origin main

          echo "Activating virtual environment..."
          source ~/.virtualenvs/ai-devtools/bin/activate

          echo "Installing dependencies..."
          pip install -r requirements.txt

          echo "Running migrations..."
          python manage.py migrate

          echo "Collecting static files..."
          python manage.py collectstatic --noinput

          echo "Setting up demo user..."
          python manage.py create_demo_user --with-sample-data

          echo "✅ Deployment commands completed successfully!"
        ENDSSH

        echo "Reloading web app via API..."
        reload_response=$(curl -s -w "\n%{http_code}" -X POST \
          "https://www.pythonanywhere.com/api/v0/user/${PYTHONANYWHERE_USERNAME}/webapps/${PYTHONANYWHERE_DOMAIN}/reload/" \
          -H "Authorization: Token ${PYTHONANYWHERE_API_TOKEN}")

        reload_http_code=$(echo "$reload_response" | tail -n1)
        reload_body=$(echo "$reload_response" | head -n-1)

        if [ "$reload_http_code" = "200" ]; then
          echo "✅ Web app reloaded successfully!"
        else
          echo "⚠️  Reload returned HTTP $reload_http_code: $reload_body"
          echo "You may need to manually reload from PythonAnywhere dashboard"
        fi

        echo ""
        echo "Deployment complete! Check your app at: https://${PYTHONANYWHERE_DOMAIN}"
