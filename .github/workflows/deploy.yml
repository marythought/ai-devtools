name: Deploy TODO App

# Trigger deployment only when the CI workflow completes successfully.
on:
  workflow_dispatch:
  workflow_run:
    workflows:
      - "CI for TODO App"
    types:
      - completed

defaults:
  run:
    working-directory: 01-todo

jobs:
  deploy:
    # Only run this job when the CI workflow completed successfully on the main branch
    if: ${{ (github.event_name == 'workflow_dispatch') || (github.event.workflow_run.conclusion == 'success' && github.event.workflow_run.head_branch == 'main') }}

    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v4

    - name: Setup SSH
      env:
        SSH_PRIVATE_KEY: ${{ secrets.PYTHONANYWHERE_SSH_KEY }}
      run: |
        mkdir -p ~/.ssh
        echo "$SSH_PRIVATE_KEY" > ~/.ssh/pythonanywhere_key
        chmod 600 ~/.ssh/pythonanywhere_key
        ssh-keyscan ssh.pythonanywhere.com >> ~/.ssh/known_hosts

    - name: Deploy to PythonAnywhere via SSH
      env:
        PYTHONANYWHERE_USERNAME: ${{ secrets.PYTHONANYWHERE_USERNAME }}
        PYTHONANYWHERE_DOMAIN: ${{ secrets.PYTHONANYWHERE_DOMAIN }}
      run: |
        echo "Starting deployment to PythonAnywhere..."

        ssh -i ~/.ssh/pythonanywhere_key \
          -o StrictHostKeyChecking=no \
          ${PYTHONANYWHERE_USERNAME}@ssh.pythonanywhere.com \
          'bash -s' << 'ENDSSH'
          set -e

          echo "Pulling latest code..."
          cd ~/ai-devtools/01-todo
          git pull origin main

          echo "Activating virtual environment..."
          source ~/.virtualenvs/ai-devtools/bin/activate

          echo "Installing dependencies..."
          pip install -r requirements.txt

          echo "Running migrations..."
          python manage.py migrate

          echo "Collecting static files..."
          python manage.py collectstatic --noinput

          echo "Setting up demo user..."
          python manage.py create_demo_user --with-sample-data

          echo "Reloading web app..."
          touch /var/www/${PYTHONANYWHERE_DOMAIN}_wsgi.py

          echo "âœ… Deployment completed successfully!"
        ENDSSH

        echo ""
        echo "Deployment complete! Check your app at: https://${PYTHONANYWHERE_DOMAIN}"
